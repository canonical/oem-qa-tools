# Testflinger job.yaml generator

This script builds a complete testflinger `job.yaml` file by using separate templates and bash scripts to better isolate each step in the deployment/testing process.

The directory structure looks like this:

- `template/template.yaml`: this is the main yaml template from which the final yaml will be generated

- `shell_scripts`: Individual bash files that will be combined and form the value of the `test_cmds` key in the final yaml file. They are merged in ascending alphabetical order of their file names.

- `launcher_config`: Launcher files used by checkbox. They contain contents of standard checkbox launcher.conf files

## Checkbox related

The following checkbox config sections are included in `final_launcher` generated by this script.
See the [checkbox docs](https://canonical-checkbox.readthedocs-hosted.com/en/latest/tutorial/using-checkbox/launcher.html) for more details

- Main configuration

  - `launcher`, `ui`, `daemon`(agent), `transport`, `exporter`, `report`: These usually don't need to be changed

- Environment section

  - `environment`: Checkbox environment variables are in this section

- Manifest

  - `manifest`: Testflinger will create or overwrite the /var/tmp/checkbox-ng/manifest.json file in the DUT with the values specified here.
    Use the `--manifestJson` flag to pass in your manifest.json file and let this script merge it into the launcher. Note that if `--testplan` isn't specified, the manifest file is ignored.

- Test plan
  - `test plan`, `test selection`: These control which test plan to run. Use the `--testplan` flag to specify the test plan. Note that the namespace is always assumed to be 'certification.canonical.com'.

## Usage

<!-- markdownlint-configure-file { "MD013": { "line_length": 200 } } -->

```text
usage: testflinger_yaml_generator.py [-h] -c CID -o OUTPUTFILENAME [--outputFolder OUTPUTFOLDER] [--dist-upgrade] [--testplan TESTPLAN] [--excludeJobs EXCLUDEJOBS]
                                     [--sessionDesc SESSIONDESC] [--checkboxType {deb,snap}] [--provisionType {distro,url}] [--provisionImage PROVISIONIMAGE]
                                     [--provisionToken PROVISIONTOKEN] [--provisionUserData PROVISIONUSERDATA] [--provisionAuthKeys PROVISIONAUTHKEYS] [--provisionOnly]
                                     [--globalTimeout GLOBALTIMEOUT] [--outputTimeout OUTPUTTIMEOUT] [--manifestJson MANIFESTJSON] [--needManifest] [--no-needManifest]
                                     [--checkboxConf CHECKBOXCONF] [--LauncherTemplate LAUNCHERTEMPLATE] [--LpID LPID] [--reserveTime RESERVETIME] [--TFYamlTemplate TFYAMLTEMPLATE]
                                     [--binFolder BINFOLDER]

Testflinger yaml file generator

options:
  -h, --help            show this help message and exit

Required:
  -c CID, --CID CID     CID (default: None)
  -o OUTPUTFILENAME, --outputFileName OUTPUTFILENAME
                        Set the output yaml file Name (default: None)

general options:
  --outputFolder OUTPUTFOLDER
                        Set the output folder path (default: ./)
  --dist-upgrade        Set to allow the dist-upgrade before run checkbox test (default: False)
  --testplan TESTPLAN   Set the checkbox test plan name. If didn't set this will not run checkbox test (default: )
  --excludeJobs EXCLUDEJOBS
                        Set the exclude jobs pattern. ie".*memory/memory_stress_ng". (default: )
  --sessionDesc SESSIONDESC
                        Set the session description (default: CE-QA-PC_Test)
  --checkboxType {deb,snap}
                        Set which checkbox type you need to install and test. (default: deb)
  --provisionType {distro,url}
                        Set the provision type (default: distro)
  --provisionImage PROVISIONIMAGE
                        The provision image. ie, desktop-22-04-2-uefi. If didn't set this mean no provision (default: )
  --provisionToken PROVISIONTOKEN
                        Optional file with username and token when image URL requires authentication (i.e Jenkins artifact). This file must be in YAML format, i.e: "username:
                        $JENKINS_USERNAME \n token: $JENKINS_API_TOKEN" (default: )
  --provisionUserData PROVISIONUSERDATA
                        user-data file for autoinstall and cloud-init provisioning. This argument is a MUST required if deploy the image using the autoinstall image (i.e. 24.04 image)
                        (default: )
  --provisionAuthKeys PROVISIONAUTHKEYS
                        ssh authorized_keys file to add in provisioned system (default: )
  --provisionOnly       Run only provisioning without tests. Removes test_data before generating the yaml. (default: False)
  --globalTimeout GLOBALTIMEOUT
                        Set the testflinger's global timeout. Max:43200 (default: 43200)
  --outputTimeout OUTPUTTIMEOUT
                        Set the output timeout if the DUT didn't response to server, it will be forced closed this job. It should be set under the global timeout. (default: 9000)

Launcher settion  options:
  --manifestJson MANIFESTJSON
                        Set the manifest json file to build the launcher. (default: $SCRIPT_PATH/template/manifest.json)
  --needManifest        Set if need the Manifest. (default: True)
  --no-needManifest
  --checkboxConf CHECKBOXCONF
                        Set the checkbox configuration file to build the launcher. (default: $SCRIPT_PATH/template/checkbox.conf)
  --LauncherTemplate LAUNCHERTEMPLATE
                        Set the launcher template folder (default: $SCRIPT_PATH/template/launcher_config/)

Testflinger yaml options:
  --LpID LPID           If you want to reserve the DUT, please input your Launchpad ID (default: )
  --reserveTime RESERVETIME
                        Set the timeout (sec) for reserve. (default: 1200)
  --TFYamlTemplate TFYAMLTEMPLATE
                        Set the testflinger template yaml file (default: $SCRIPT_PATH/template/template.yaml)

Test command in testflinger yaml:
  --binFolder BINFOLDER
                        Set the testflinger test command folder (default: $SCRIPT_PATH/template/shell_scripts/)
```

### Basic usage

To keep these examples short, we will use the default timeout and default template paths.

- If any of the test commands need to be modified, edit the `./template/shell_scripts/*` bash scripts. Most of the time we only need to modify `20_before_test` and `99_end_test`

Generally we start with something like this:

```bash
python3 testflinger_yaml_generator.py \
  -c $CID \ # the machine to test
  -o $OUTPUT_YAML \ # where to write the job yaml file
  --LpID $LP_ID \ # your launchpad id for ssh auth
  --testplan $TEST_PLAN \ # checkbox test plan to run
  --provisionImage $IMAGE_NAME \ # image to deploy
  --manifestJson $MANIFEST_JSON_PATH # path to your manifest.json
```

Short examples:

- If we only want to provision and reserve the machine (for interactive sessions):

```bash
python3 testflinger_yaml_generator.py \
  -c $CID \
  -o $OUTPUT_YAML \
  --LpID $LP_ID \
  --provisionImage $IMAGE_NAME
```

- If we only want to test without provision:

```bash
python3 testflinger_yaml_generator.py \
  -c $CID \
  -o $OUTPUT_YAML \
  --LpID $LP_ID \
  --testplan $TEST_PLAN \
  --manifestJson $MANIFEST_JSON_PATH
```

- If we only want to provision without anything in `test_cmds`

```bash
python3 testflinger_yaml_generator.py \
  -c $CID \
  -o $OUTPUT_YAML \
  --LpID $LP_ID \
  --provisionImage $IMAGE_NAME \
  --provisionOnly
```

## Helper functions exposed by 00_initial

The bash script `template/shell_scripts/00_initial` exposes these helper functions that you can use if you need to add commands:

```
_put(local_path, remote_path)
```
-  Uploads a local file to the DUT. Both arguments are plain paths. What "local" refers to will depend on where the scripts are eventually executed (e.g. on a Jenkins host)

```
_get(remote_path, local_path)
```
- The opposite of `_put`; downloads a file from the DUT to local

```
_run(command, ...args)
```
- Runs a command on the dut. The arguments are just normal shell syntax

```
_run_in_bg(command, ...args)
```
- Adds the `-f` flag to ssh. See `man ssh` for details.

```
wait_for_ssh()
```
- Keep trying to connect to the DUT for 40 times. Each attempt will wait 120 seconds for the DUT to respond. 


## How to test and provision cert lab's DUTs with this script

**Prepare these values:** CID, provision_image_name, manifest_json_file, test_plan_name.

**Modify these files if necessary:** `20_before_test` (for example if we want to add staging ppa repos), `99_end_test` (maybe copy some files into the artifacts folder)

```sh
git clone --depth 1 --branch main git@github.com:canonical/ce-oem-dut-checkbox-configuration.git
# if `$CID` in `PC/` folder, we can use the `PC/$CID/manifest.json` and `PC/$CID/checkbox.conf`
# as `$MANIFEST_JSON_PATH` and `$CHECKBOX_CONF_PATH`
# else we can use the `PC/default/manifest.json` `PC/default/checkbox.conf` or
# `./template/manifest.json` `./template/checkbox.conf` we modify by ourselves

./testflinger_yaml_generator.py \
  -c $CID \
  -o $OUTPUT_YAML \
  --LpID $LP_ID \
  --testplan $TEST_PLAN \
  --provisionImage $IMAGE_NAME \
  --manifestJson $MANIFEST_JSON_PATH \
  --checkboxConf $CHECKBOX_CONF_PATH

JOB_ID=$(testflinger-cli -q $OUTPUT_YAML)
testflinger-cli poll $JOB_ID
TEST_STATUS=$(testflinger results $JOB_ID | jq -r .test_status)

testflinger artifacts $JOB_ID
```

## How to test IOT devices with provision via this script

**Prepare these values**: manifest_json_file, checkbox_conf ,test_plan_name, checkbox_snap_install_script.

**Modify these files:** `/template/shell_scripts/02_Install_checkbox_snap` (based
on your checkbox snap install script and follow the original file structure).

> [!NOTE]
> If you don't have the launcher or your manifest is already inside checkbox.conf, eg:
>
> ```text
> [manifest]
> abc::has_stuff = true
>
> [environment]
> MY_ENV_VAR = 123
> ```
>
> You can use the `--no-needManifest` flag to provide just the checkbox.conf file
> `./testflinger_yaml_generator.py -c $CID --checkboxType snap --testplan $TEST_PLAN --no-needManifest --checkboxConf $CHECKBOX_CONF_WITH_MANIFEST`

```sh
git clone --depth 1 --branch main git@github.com:canonical/ce-oem-dut-checkbox-configuration.git
# if `$CID` in `IOT/` folder, we can modify the `IOT/$CID/launcher` and only
# left the `manifest` and `environment` field as `$CHECKBOX_CONF_PATH`
# else we need to create the `./template/manifest.json` and
# `./template/checkbox.conf` we by ourselves

./testflinger_yaml_generator.py
  -c $CID \
  -o $OUTPUT_YAML \
  --LpID $LP_ID \
  --testplan $TEST_PLAN \
  --provisionImage $IMAGE_NAME \
  --manifestJson $MANIFEST_JSON_PATH \
  --checkboxConf $CHECKBOX_CONF_PATH

JOB_ID=$(testflinger-cli -q $OUTPUT_YAML)
testflinger-cli poll $JOB_ID
TEST_STATUS=$(testflinger results $JOB_ID | jq -r .test_status)

testflinger artifacts $JOB_ID
```
