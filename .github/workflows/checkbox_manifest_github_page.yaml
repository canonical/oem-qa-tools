name: Deploy Checkbox Manifest to GitHub Pages

on:
  workflow_dispatch: # Allows manual triggering
  schedule:
    # Runs every Sunday at 00:00 UTC
    - cron: '0 0 * * SUN'

jobs:
  build-and-deploy:
    runs-on: [self-hosted, x64, linux]
    permissions:
      contents: write # To push the generated index.html
      pages: write    # To deploy to GitHub Pages
      id-token: write # To authenticate with GitHub Pages

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install canonical checkbox client
        run: |
          sudo add-apt-repository ppa:checkbox-dev/beta -y
          sudo apt-get update -qq
          sudo apt-get install canonical-certification-client checkbox-provider-gpgpu -qq -y

      - name: Generate manifest.json
        run: |
          checkbox-cli expand com.canonical.certification::client-cert-desktop-24-04 -f json > full_manifest.json
          checkbox-cli expand com.canonical.certification::client-cert-desktop-24-04-automated -f json > auto_manifest.json

      - name: Generate GitHub Page (pc-full.html)
        uses: canonical/oem-qa-tools/.github/actions/manifest-select@main
        with:
          checkbox_expand: full_manifest.json
          output_file_name: pc-full.html

      - name: Generate GitHub Page (pc-auto.html)
        uses: canonical/oem-qa-tools/.github/actions/manifest-select@main
        with:
          checkbox_expand: auto_manifest.json
          output_file_name: pc-auto.html

      - name: Create index.html for multiple page
        run: |
          cat << EOF > index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Client Certification</title>
              <link href="https://assets.ubuntu.com/v1/vanilla-framework-version-3.13.0.min.css" rel="stylesheet" />
              <style>
                  body {
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      min-height: 100vh;
                      margin: 0;
                      background-color: #f7f7f7;
                      font-family: 'Inter', sans-serif;
                  }
                  .button-container {
                      display: flex;
                      gap: 20px;
                      flex-wrap: wrap;
                      justify-content: center;
                  }
                  .p-button {
                      padding: 1rem 2rem;
                      font-size: 1.1rem;
                      border-radius: 8px;
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                  }
                  .p-button:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
                  }
                  .btn-left {
                      background-color: #007bff;
                      color: white;
                      border: 1px solid #007bff;
                  }
                  .btn-left:hover {
                      background-color: #0056b3;
                      border-color: #0056b3;
                  }
                  .btn-right {
                      background-color: #28a745;
                      color: white;
                      border: 1px solid #28a745;
                  }
                  .btn-right:hover {
                      background-color: #218838;
                      border-color: #218838;
                  }

                  @media (max-width: 600px) {
                      .button-container {
                          flex-direction: column;
                          align-items: center;
                      }
                      .p-button {
                          width: 80%;
                          max-width: 300px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="button-container">
                  <button class="p-button btn-left" onclick="window.open('pc-full.html', '_blank');">
                      client-cert-desktop-24-04
                  </button>

                  <button class="p-button btn-right" onclick="window.open('pc-auto.html', '_blank');">
                      client-cert-desktop-24-04-automated
                  </button>
              </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          enablement: true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './' # Uploads the entire current directory, which contains index.html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

